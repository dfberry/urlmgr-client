import { Component, KeyValueDiffers, DoCheck} from '@angular/core';
import { AbstractControl, FormGroup, FormControl, Validators, FormBuilder, ReactiveFormsModule, FormsModule } from '@angular/forms';
import { RouterModule, Routes, Router, ActivatedRoute  } from '@angular/router'; 
import { Http, Response, URLSearchParams, Headers, RequestOptions} from '@angular/http';
import { Observable } from 'rxjs/Rx';

import { Configuration } from '../config';
import { ClientAuthenticationService, UserEvent } from '../services';
import { User } from '../index';
import { Broadcaster } from '../../services';

@Component({
    selector: 'login',
    template: ` 
      <div class="col-md-6">
          <h2>Login</h2>

          <form name="loginForm" (ngSubmit)="login()" >
                <div id="loginerrorcontainer" type="loginerrorcontainer" *ngIf="authentication.error" class="form-group has-error">
                    <label id="loginerrors" type="loginerrors" class="control-label" >{{authentication.error}}</label>
                </div>
              <div class="form-group email" >
                  <label for="user">Email</label>
                  <input type="email" class="form-control" [(ngModel)]="email" name="email" placeholder="Your email here" required email/>
                  <div id="emailerrorcontainer" type="emailerrorcontainer" *ngIf="!authentication.user.email.valid" class="email form-group has-error">
                    <label id="emailerrors" type="emailerrors" class="email errors control-label" >{{authentication.user.email.errorMsg}}</label>
                  </div>
              </div>
              <div class="form-group" >
                  <label for="password">Password</label>
                  <input type="password"  class="form-control" [(ngModel)]="password" name="password" placeholder="Your password here" (blur)="validatePassword()" />
                  <div id="passworderrorcontainer" type="passworderrorcontainer" *ngIf="!authentication.user.password.valid" class="password form-group has-error">
                    <label id="passworderrors" type="passworderrors" class="password errors control-label" >{{authentication.user.password.errorMsg}}</label>
                  </div>
              </div>
              <div class="form-group">
                  <button id="loginButton" type="submit" [disabled]="!authentication.valid" class="btn btn-primary" >Login</button>
                  <img *ngIf="loading" src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==" />
              </div>

          </form>
      </div>
    `
})
export class LoginComponent {
    config: any;
    newForm: FormGroup;
    user: User;
    email: string;
    password: string;
    fieldsValid: boolean;

    constructor(
        //public serverAuthService: ServerAuthenticationService, /* for server auth */
        private router: Router,
        private clientAuthService: ClientAuthenticationService, /* for client auth */
        private userEvent: UserEvent, /* for state events */ 
        private activatedRoute: ActivatedRoute,
        private broadcaster: Broadcaster
    ){

        this.activatedRoute.queryParams.subscribe( data => {
            //console.log('queryParams', data['logout']);
            if(data['logout']) {
                this.clientAuthService.getCurrentUser().subscribe(user => {
                    this.logout();
                });  
                
            }
        });
    }
    ngOnInit() {  
        console.log("loginComponent ngOnInit");
        this.registerBroadcastReceiver();
     }
    login() {
        this.userEvent.fire('USER_LOGON_REQUESTED',{email: this.email,password: this.password});
    }
    logout() {
        if(this.user && this.user.id && this.user.isAuthenticated){   
            this.userEvent.fire('USER_LOGOUT_REQUESTED',this.user);
        }
    }
    registerBroadcastReceiver() {
        let self = this;
        this.broadcaster.on<any>(MessageEvent)
        .subscribe(message => {

            console.log("registerBroadcastReceiver message");
            console.log(message);

            if (!message || !message.event || !message.data) throw Error("malformed serverUserEvent");
            switch (message.event) {
            case "USER_LOGON_RESPONSE_SUCCESS":
                // received message the user logged on
                // need to set state to that user
                console.log("USER_LOGON_RESPONSE_SUCCESS"  + JSON.stringify(message));
                this.clientAuthService.setCurrentAuthenticatedUserFromJson(message.data);
                this.router.navigate(['/']);
                return;
            case "USER_LOGON_FAILURE":
                console.log("USER_LOGON_FAILURE");
                return; 
            case "USER_LOGOUT_SUCCESS":
                // received message the user logged out
                // need to set state to that user
                //this.store.dispatch({type: UserActions.USER_LOGOUT, payload: undefined});
                console.log("USER_LOGOUT_SUCCESS");
                this.clientAuthService.removeCurrentUser();
                //this.serverAuthService.deAuthenticateToServer(this.user, url);
                this.user = new User();
                
                self.email="";
                self.password="";

                this.router.navigate(['/']);
                return;
            case "USER_LOGOUT_FAILURE":
                // received message the user logged out
                // need to set state to that user
                //this.store.dispatch({type: UserActions.USER_LOGOUT, payload: undefined});
                console.log("USER_LOGOUT_FAILURE");
                return;

            }
        });
    }
}