import { Component, KeyValueDiffers, DoCheck} from '@angular/core';
import { AbstractControl, FormGroup, FormControl, Validators, FormBuilder, ReactiveFormsModule, FormsModule } from '@angular/forms';
import { RouterModule, Routes, Router } from '@angular/router'; 
import { Http, Response, URLSearchParams, Headers, RequestOptions, RequestOptionsArgs} from '@angular/http';
import { Observable } from 'rxjs/Rx';

// user module only
import { User } from '../user.model';
import { AuthenticationHttpService, AuthenticationService, UserEvent } from '../services';
import { Configuration } from '../config'; // configuration inside user module only

@Component({
    selector: 'login',
    template: ` 
      <div class="col-md-6">
          <h2>Login</h2>

          <form (submit)="login()">
                  <div id="loginerrorcontainer" type="loginerrorcontainer"  *ngIf="auth.error" class="form-group has-error">
                    <label id="loginerrors" type="loginerrors" class="control-label" >{{auth.error}}</label>
                </div>            
              <div class="form-group email" >
                  <label for="email">email</label>
                  <input type="text" type="email" class="form-control" [(ngModel)]="auth.user.email.value" name="email" placeholder="Your email here" required (blur)="validateEmail()" />
              </div>
              <div class="form-group password" >
                  <label for="password">Password</label>
                  <input type="password" class="form-control" [(ngModel)]="auth.user.password.value" name="password" placeholder="Your password here"  required  (blur)="validatePassword()" />
              </div>
              <div class="form-group">
                  <button id="loginButton" type="submit" [disabled]="!auth.valid" class="btn btn-primary">Login</button>
                  <img *ngIf="loading" src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==" />
              </div>

          </form>
          <div type="debug" name="debug" id="debug" >{{ auth | json }}</div>
      </div>
      
    `
})
export class LoginComponent  implements DoCheck {
    config: any;
    newForm: FormGroup;

    title = "Login";

    auth = {
        error: "",
        valid: false,
        loading: false,
        authorized: false,
        response: {},
        user:{
            password: {
                dirty: false,
                value:"",
                valid: -1,
                errorMsg: ""
            },
            email : {
                dirty: false,
                value: "",
                valid: -1,
                errorMsg: ""
            }
        }
    };


    //email="";
    //password="";
    baseUrl;
    //authError="";
    //authorized=false;
    authenticatedUser:User;

    constructor(
        private authService: AuthenticationService, /* for client auth */
        private router: Router, /* go to Dashboard after successful auth */
        private userEvent: UserEvent, /* for state events */
        private authHttpService: AuthenticationHttpService /* for server auth */,
        private differs: KeyValueDiffers
        )
    {}

    ngOnInit() {  
        this.auth.loading = false;

     }
    ngDoCheck() {
        //console.log("ngDoCheck called");
        //console.log("ngDoCheck, user = " + JSON.stringify(this.auth.user));
        this.checkRequiredFields();
    }
    checkRequiredFields(){
    //console.log("checkRequiredFields, user = " + JSON.stringify(this.auth.user));
        if(this.auth.user.email.valid==1 && this.auth.user.password.valid==1){
            this.auth.valid = true;
        } else {
            this.auth.valid = false;
        }
        //console.log("login checkRequiredFields " + this.auth.valid);
    }
    validateEmail() {
       /* console.log("validateEmail, user = " + JSON.stringify(this.auth.user));
       this.auth.user.email.dirty = true;
       
        if (this.auth.user.email.value){
            console.log("email has value");
            this.auth.user.email.valid = 1;
            this.auth.user.email.errorMsg = "";
        } else {
            this.auth.user.email.valid = 0;
            this.auth.user.email.errorMsg = "user is empty";
            console.log("user is empty");
        }
        */
    }
    validatePassword() {
        console.log("validatePassword, user = " + JSON.stringify(this.auth.user));
        this.auth.user.password.dirty = true;
        if (this.auth.user.password.value.length > 0) {
            console.log("password is valid length");
            this.auth.user.password.valid = 1;
            this.auth.user.password.errorMsg = "";
        } else {
            this.auth.user.password.valid = 0;
            this.auth.user.password.errorMsg = "password is required";
            console.log("password is not valid length");
        }
    }
    login() {

        console.log("########################################login called#############################################");

        //console.log("login function");
        //console.log("email " + this.email);
        //console.log("password " + this.password);

        let authObj = {
            email: this.auth.user.email.value,
            password: this.auth.user.password.value
        };

        console.log(authObj);

        this.authHttpService.authenticateToServer(authObj, Configuration.urls.base + "/auth" ).then(json => {
        
                console.log("authenticateToServer success ");
                console.log(json);
                let user = json.data;

                // success should sent us to dashboard

                

                if (user && user.token) {
                    console.log("inside user");
                    this.authenticatedUser = new User();
                    this.authenticatedUser.transform(user);

                    this.authenticatedUser["isAuthenticated"]=true;
                    this.auth.authorized = true;
                    console.log("authorized set to true");
                    this.authService.setCurrentUser(this.authenticatedUser);
                    this.userEvent.fire('USER_LOGON');
                    this.router.navigate(['/dashboard']);
                } else {
                    console.log("user not returned correctly");
                    console.log(user);
                }
            })
            .catch((err: any) => {
                // don't go any where, just set error text
                console.log("login failure - " + err);
                this.auth.error = "An unexpected error occured";
                this.auth.authorized=false;

                console.log("err._body" + err._body);
                if(err && err._body){

                    //let response = JSON.parse(err._body);
                    this.auth.error = err._body;
                    console.log("this.authentication.error = " + this.auth.error);
                }
            });
    }
 
}